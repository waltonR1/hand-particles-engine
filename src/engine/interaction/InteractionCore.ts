import type { InteractionEvent } from "./InteractionTypes";
import { clamp01 } from "../../utils/math";
import type { ShapeName } from "../particles/ShapeTypes";

/**
 * ======================================================
 * InteractionState
 * ======================================================
 *
 * InteractionState æ˜¯ã€Œè§†è§‰ç³»ç»Ÿå”¯ä¸€å…³å¿ƒçš„è¾“å…¥çŠ¶æ€ã€ã€‚
 *
 * æ ¸å¿ƒæ€æƒ³ï¼ˆIMPORTANTï¼‰ï¼š
 * - æ‰‹åŠ¿ç³»ç»Ÿã€è¾“å…¥ç³»ç»Ÿ â†’ äº§ç”Ÿ InteractionEvent
 * - InteractionCore â†’ æŠŠâ€œç¦»æ•£äº‹ä»¶æµâ€æ±‡æ€»æˆâ€œè¿ç»­çŠ¶æ€â€
 * - ç²’å­ / æ¸²æŸ“ç³»ç»Ÿ â†’ åªè¯»å– InteractionState
 *
 * æ¢å¥è¯è¯´ï¼š
 * ğŸ‘‰ è§†è§‰ç³»ç»Ÿä¸éœ€è¦çŸ¥é“â€œå‘ç”Ÿäº†ä»€ä¹ˆæ‰‹åŠ¿â€
 * ğŸ‘‰ åªéœ€è¦çŸ¥é“â€œç°åœ¨åº”è¯¥é•¿ä»€ä¹ˆæ ·â€
 *
 * è¿™æ˜¯ä¸€ç§ï¼š
 * - Event-driven â†’ State-driven çš„æ¶æ„è¿‡æ¸¡å±‚
 * ======================================================
 */
export type InteractionState = {

    /**
     * å½“å‰äº¤äº’æ¨¡å¼
     *
     * è¯­ä¹‰ï¼š
     * - NONE   ï¼šæ— æ‰‹ / æ— è¾“å…¥
     * - SINGLE ï¼šå•æ‰‹äº¤äº’
     * - DUAL   ï¼šåŒæ‰‹äº¤äº’
     *
     * ç”¨é€”ï¼š
     * - æ§åˆ¶ç²’å­ç³»ç»Ÿçš„è¡Œä¸ºåˆ†æ”¯
     * - åˆ‡æ¢ä¸åŒäº¤äº’é€»è¾‘
     */
    mode: "NONE" | "SINGLE" | "DUAL";

    /**
     * å¹³ç§»ï¼ˆä¸–ç•Œåæ ‡ï¼‰
     *
     * è¯´æ˜ï¼š
     * - è¿™æ˜¯å·²ç»æ˜ å°„åˆ°â€œä¸–ç•Œç©ºé—´â€çš„å€¼
     * - ä¸å†æ˜¯å±å¹•å½’ä¸€åŒ–åæ ‡
     *
     * ä½¿ç”¨æ–¹å¼ï¼š
     * - ç²’å­ç³»ç»Ÿå¯ç›´æ¥ä½¿ç”¨ panX / panY
     */
    panX: number;
    panY: number;

    /**
     * ç¼©æ”¾å› å­ï¼ˆä¸–ç•Œ scaleï¼‰
     *
     * è¯­ä¹‰ï¼š
     * - è¡¨ç¤ºç›®æ ‡ç¼©æ”¾å€¼
     * - æ˜¯å¦å¹³æ»‘ã€å¦‚ä½•å¹³æ»‘ï¼Œç”±ç²’å­ç³»ç»Ÿå†³å®š
     */
    zoom: number;

    /**
     * æ—‹è½¬è§’åº¦
     *
     * è¯­ä¹‰ï¼š
     * - å›´ç»• Z è½´çš„æ—‹è½¬
     * - é€šå¸¸åªåœ¨ DUAL æ¨¡å¼ä¸‹æœ‰æ„ä¹‰
     *
     * å•ä½ï¼š
     * - å¼§åº¦ï¼ˆradiansï¼‰
     */
    rotation: number;

    /**
     * èšæ•£ç¨‹åº¦
     *
     * æ•°å€¼çº¦å®šï¼š
     * - spread âˆˆ [0, 1]
     *
     * è¯­ä¹‰ï¼š
     * - 0   â†’ éå¸¸é›†ä¸­
     * - 1   â†’ éå¸¸åˆ†æ•£
     */
    spread: number;

    /**
     * è„‰å†²å‹äº‹ä»¶ï¼šscatter / converge
     *
     * è®¾è®¡è¯´æ˜ï¼ˆIMPORTANTï¼‰ï¼š
     * - è¿™ä¸¤ä¸ªå­—æ®µåªåœ¨â€œå½“å‰å¸§â€æœ‰æ•ˆ
     * - update() æ¯æ¬¡éƒ½ä¼šå…ˆé‡ç½®ä¸º false
     *
     * ä½¿ç”¨æ–¹å¼ï¼š
     * - ç²’å­ç³»ç»Ÿæ£€æµ‹åˆ° true â†’ è§¦å‘ä¸€æ¬¡æ€§æ•ˆæœ
     */
    scatter: boolean;
    converge: boolean;

    /**
     * é™æ­¢ç¨‹åº¦
     *
     * æ•°å€¼çº¦å®šï¼š
     * - stillness âˆˆ [0, 1]
     * - 1 è¡¨ç¤ºéå¸¸ç¨³å®š / é™æ­¢
     *
     * ä½¿ç”¨åœºæ™¯ï¼š
     * - å‘¼å¸åŠ¨ç”»
     * - idle çŠ¶æ€è¿‡æ¸¡
     */
    stillness: number;

    /**
     * å½“å‰ç›®æ ‡å½¢çŠ¶
     *
     * è¯­ä¹‰ï¼š
     * - è¡¨ç¤ºâ€œå¸Œæœ›å‘ˆç°çš„å½¢çŠ¶â€
     * - æ˜¯å¦ç«‹å³åˆ‡æ¢ or å¹³æ»‘è¿‡æ¸¡ï¼Œç”±ç²’å­ç³»ç»Ÿå†³å®š
     */
    shape: ShapeName;

    /**
     * UI å±•ç¤ºç”¨ï¼šå½“å‰è¯†åˆ«åˆ°çš„æ‰‹åŠ¿æ ‡ç­¾
     *
     * æ³¨æ„ï¼š
     * - ä¸å‚ä¸ä»»ä½•ç‰©ç† / ç²’å­è®¡ç®—
     * - çº¯è°ƒè¯• / UI åé¦ˆç”¨é€”
     */
    gestureLabel: string;

    /**
     * UI å±•ç¤ºç”¨ï¼šæŠ–åŠ¨èƒ½é‡
     *
     * è¯­ä¹‰ï¼š
     * - æè¿°å½“å‰è¾“å…¥çš„â€œèºåŠ¨ç¨‹åº¦â€
     * - ä¸ç›´æ¥é©±åŠ¨è¡Œä¸º
     */
    shakeEnergy: number;
};


/**
 * ======================================================
 * InteractionCore
 * ======================================================
 *
 * InteractionCore çš„èŒè´£ï¼š
 * - æ¥æ”¶ä¸€å¸§å†…äº§ç”Ÿçš„ InteractionEvent[]
 * - æŒ‰è§„åˆ™â€œå½’å¹¶ / è¦†ç›– / è§¦å‘â€
 * - ç”Ÿæˆä¸€ä¸ªç¨³å®šã€å®Œæ•´çš„ InteractionState
 *
 * æ ¸å¿ƒç‰¹æ€§ï¼š
 * - æ— å†å²ï¼ˆä¸å­˜ä¸Šä¸€å¸§çŠ¶æ€ï¼‰
 * - è¡Œä¸ºå®Œå…¨ç”± events å†³å®š
 * - ä¸åšå¹³æ»‘ã€ä¸åšåŠ¨ç”»
 *
 * è¿™ä½¿å®ƒæˆä¸ºï¼š
 * ğŸ‘‰ ä¸€ä¸ªâ€œçº¯è¯­ä¹‰ reducerâ€
 * ======================================================
 */
export class InteractionCore {

    /**
     * å½“å‰äº¤äº’çŠ¶æ€
     *
     * åˆå§‹å€¼è¯´æ˜ï¼š
     * - è¡¨ç¤ºç³»ç»Ÿå¯åŠ¨æ—¶çš„â€œé»˜è®¤è§†è§‰çŠ¶æ€â€
     * - å¯è¢«ç¬¬ä¸€å¸§äº‹ä»¶ç«‹å³è¦†ç›–
     */
    state: InteractionState = {
        mode: "NONE",
        panX: 0,
        panY: 0,
        zoom: 1,
        rotation: 0,
        spread: 0.25,
        scatter: false,
        converge: false,
        stillness: 1,
        shape: "SPHERE",
        gestureLabel: "NONE",
        shakeEnergy: 0,
    };

    /**
     * updateï¼šå°†ä¸€å¸§å†…çš„äº‹ä»¶åˆ—è¡¨æ±‡æ€»ä¸ºç»Ÿä¸€çŠ¶æ€
     *
     * è¡Œä¸ºè¯´æ˜ï¼ˆIMPORTANTï¼‰ï¼š
     * - events æ˜¯â€œè¿™ä¸€å¸§æ‰€æœ‰è¯­ä¹‰äº‹ä»¶â€çš„é›†åˆ
     * - é¡ºåºå¯èƒ½å½±å“æœ€ç»ˆç»“æœï¼ˆåæ¥çš„äº‹ä»¶è¦†ç›–å‰é¢çš„ï¼‰
     *
     * è„‰å†²äº‹ä»¶è¯´æ˜ï¼š
     * - scatter / converge åœ¨æ¯æ¬¡ update å¼€å§‹æ—¶è¢«æ¸…é›¶
     * - åªæœ‰å½“æœ¬å¸§ events ä¸­åŒ…å«å¯¹åº”äº‹ä»¶æ—¶æ‰ä¸º true
     */
    update(events: InteractionEvent[]) {

        // ==========================
        // 1ï¸âƒ£ é‡ç½®è„‰å†²å‹çŠ¶æ€
        // ==========================
        this.state.scatter = false;
        this.state.converge = false;

        // ==========================
        // 2ï¸âƒ£ é€äº‹ä»¶å½’å¹¶
        // ==========================
        for (const e of events) {
            switch (e.type) {

                case "MODE":
                    this.state.mode = e.mode;
                    break;

                case "MOVE": {
                    /**
                     * MOVE äº‹ä»¶ä½¿ç”¨çš„æ˜¯â€œå½’ä¸€åŒ–å±å¹•åæ ‡â€
                     *
                     * è¿™é‡Œåšçš„äº‹æƒ…ï¼š
                     * - æŠŠ [0, 1] æ˜ å°„åˆ°ä¸–ç•Œç©ºé—´
                     * - åŒæ—¶å¯¹ Y è½´å–åï¼ˆå±å¹• â†’ ä¸–ç•Œï¼‰
                     *
                     * ç»éªŒå‚æ•°è¯´æ˜ï¼š
                     * - 3.0 / 1.9 æ˜¯è§†è§‰æ¯”ä¾‹ç›¸å…³çš„ç¼©æ”¾å› å­
                     */
                    this.state.panX = (e.nx - 0.5) * 3.0;
                    this.state.panY = -(e.ny - 0.5) * 1.9;
                    break;
                }

                case "ZOOM":
                    // ç›´æ¥è®¾ç½®ç›®æ ‡ç¼©æ”¾å€¼
                    // æ˜¯å¦å¹³æ»‘ç”±ç²’å­ç³»ç»Ÿå†³å®š
                    this.state.zoom = e.value;
                    break;

                case "ROTATE":
                    this.state.rotation = e.angle;
                    break;

                case "SPREAD":
                    // å¼ºåˆ¶çº¦æŸåœ¨ [0, 1]
                    this.state.spread = clamp01(e.value);
                    break;

                case "SHAPE":
                    this.state.shape = e.name;
                    break;

                case "SCATTER":
                    // è„‰å†²ï¼šåªåœ¨å½“å‰å¸§æœ‰æ•ˆ
                    this.state.scatter = true;
                    break;

                case "CONVERGE":
                    this.state.converge = true;
                    break;

                case "IDLE":
                    this.state.stillness = clamp01(e.stillness);
                    break;

                case "GESTURE_LABEL":
                    this.state.gestureLabel = e.label;
                    break;

                case "SHAKE_ENERGY":
                    this.state.shakeEnergy = e.value;
                    break;
            }
        }
    }
}
