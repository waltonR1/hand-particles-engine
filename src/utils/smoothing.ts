// =======================================
// EMA（Exponential Moving Average）
// 指数滑动平均，用于时间序列平滑
// =======================================
//
// 设计目的：
// - 对“随时间抖动”的标量数据进行平滑处理
// - 在手势系统中，常用于：
//   - 手势位置 / 距离 / 强度
//   - 缩放倍率、旋转角度等连续信号
//
// 核心特点：
// - 对最新数据更敏感（相较于简单滑动平均）
// - 内存占用 O(1)，只维护一个历史值
// - 非对称：历史影响随时间指数衰减
//
// 数学定义：
//   EMAₙ = α · xₙ + (1 − α) · EMAₙ₋₁
//
// 其中：
// - xₙ     ：当前输入值
// - EMAₙ   ：当前平滑后的输出
// - α ∈ (0, 1]：平滑系数
//
// α 的直觉含义：
// - α 越大 → 越“跟手”，响应快但抖动大
// - α 越小 → 越“稳定”，响应慢但更平滑
//
// ⚠️ 隐式约定（IMPORTANT）：
// - 本实现不对 alpha 做范围校验
// - 调用方需保证：0 < alpha ≤ 1
// - alpha = 1 等价于“不平滑”
// =======================================

export class EMA {

    /**
     * inited：是否已经接收过第一次输入
     *
     * 设计原因：
     * - EMA 递推公式依赖“上一个 EMA 值”
     * - 第一次 update 时并不存在 EMA₋₁
     * - 因此需要用第一次输入值作为初始状态
     *
     * 状态含义：
     * - false：尚未初始化（还没收到任何数据）
     * - true ：已经至少 update 过一次
     */
    private inited = false;

    /**
     * value：当前 EMA 状态值
     *
     * 含义：
     * - 在初始化前：值无实际意义（默认 0）
     * - 初始化后：始终保存“最近一次平滑后的结果”
     *
     * 注意：
     * - 这是一个有状态变量（stateful）
     * - EMA 实例不能被多个“独立信号源”共享
     */
    private value: number = 0;

    /**
     * 构造函数
     *
     * @param alpha 平滑系数（smoothing factor）
     *
     * 经验取值（仅作为参考）：
     * - 手势位置：0.2 ~ 0.4
     * - 手势距离/强度：0.1 ~ 0.3
     * - 角度类参数：0.15 ~ 0.25
     *
     * ⚠️ 再次强调：
     * - 本类不做参数校验
     * - 若 alpha ≤ 0 或 > 1，行为将不符合 EMA 定义
     */
    constructor(private alpha: number) {}

    /**
     * update：输入新数据并更新 EMA 状态
     *
     * 行为分两种情况：
     *
     * 1️⃣ 第一次调用（尚未初始化）
     * - 直接将 value 设为当前输入 x
     * - 不做平滑（避免从 0 开始导致突变）
     * - 标记 inited = true
     *
     * 2️⃣ 后续调用
     * - 使用标准 EMA 递推公式：
     *     value = α · x + (1 − α) · value
     *
     * 设计选择说明：
     * - 第一次“直通”输入是业界常见做法
     * - 这样可以保证 EMA 输出与真实信号在时间轴上对齐
     *
     * @param x 当前时间点的原始输入值
     * @returns 当前时间点的 EMA 输出值
     */
    update(x: number): number {
        if (!this.inited) {
            // 首次输入：直接初始化 EMA 状态
            this.value = x;
            this.inited = true;
            return this.value;
        }

        // 标准指数滑动平均更新公式
        this.value = this.alpha * x + (1 - this.alpha) * this.value;
        return this.value;
    }

    /**
     * get：获取当前 EMA 状态值（不更新）
     *
     * 使用场景：
     * - 需要读取“最近一次平滑结果”，但不想引入新数据
     * - 调试 / 可视化 / 状态同步
     *
     * 注意：
     * - 若在任何 update 调用之前调用：
     *   - 将返回初始值 0
     *   - 这一点由调用方自行保证
     *
     * @returns 当前保存的 EMA 值
     */
    get(): number {
        return this.value;
    }
}
